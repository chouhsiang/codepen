<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  

    <link rel="apple-touch-icon" type="image/png" href="https://cpwebassets.codepen.io/assets/favicon/apple-touch-icon-5ae1a0698dcc2402e9712f7d01ed509a57814f994c660df9f7a952f3060705ee.png" />

    <meta name="apple-mobile-web-app-title" content="CodePen">

    <link rel="shortcut icon" type="image/x-icon" href="https://cpwebassets.codepen.io/assets/favicon/favicon-aec34940fbc1a6e787974dcd360f2c6b63348d4b1f4e06c77743096d55480f33.ico" />

    <link rel="mask-icon" type="image/x-icon" href="https://cpwebassets.codepen.io/assets/favicon/logo-pin-b4b4269c16397ad2f0f7a01bcdf513a1994f4c94b8af2f191c09eb0d601762b1.svg" color="#111" />



  
    <script src="https://cpwebassets.codepen.io/assets/common/stopExecutionOnTimeout-2c7831bb44f98c1391d6a4ffda0e1fd302503391ca806e7fcc7b9b87197aec26.js"></script>


  <title>CodePen - Untitled</title>

    <link rel="canonical" href="https://codepen.io/chouhsiang/pen/ZEgzeYq">
  
  
  
  
<style>
body {
  display: -webkit-box;
  display: flex;
  -ms-flex-align: center;
  -ms-flex-pack: center;
  -webkit-box-align: center;
  align-items: center;
  -webkit-box-pack: center;
  justify-content: center;
  padding-top: 40px;
  padding-bottom: 40px;
  background-color: #f5f5f5;
}
#main {
  max-width: 800px;
  margin: 0 20px;
}
</style>

  <script>
  window.console = window.console || function(t) {};
</script>

  
  
</head>

<body translate="no">
  <div id="main">
  <h1 class="text-center mb-3">自然人憑證 CAdES 數位簽章</h1>
  <div>
    <p class="text-center">以自然人憑證為檔案做離線的 CAdES (<a href="https://datatracker.ietf.org/doc/html/rfc5126" target="_blank">RFC 5126</a>) 數位簽章，輸出 <a href="https://datatracker.ietf.org/doc/html/rfc5126#appendix-F.2.1" target="_blank">p7m</a> 或 <a href="https://datatracker.ietf.org/doc/html/rfc5126#appendix-F.2.2" target="_blank">p7s</a> 封裝格式，可透過 openssl 進行驗簽</p>
    <p class="text-center">p7m 封裝格式內包含原始檔案與數位簽章，p7s 封裝格式僅包含數位簽章不包含原始檔案</p>
  </div>
  <div class="mb-3">
    <label for="fileInput">檔案</label>
    <input type="file" class="form-control" id="fileInput">
  </div>
  <div class="row">
    <div class="col-md-6 mb-3">
      <label for="firstName">Hash 演算法</label>
      <select class="form-select" id="hashAlgo">
        <option value="SHA-1">SHA1</option>
        <option value="SHA-256" selected>SHA256</option>
        <option value="SHA-384">SHA384</option>
        <option value="SHA-512">SHA512</option>
      </select>
    </div>
    <div class="col-md-6 mb-3">
      <label for="lastName">自然人憑證 PIN 碼</label>
      <input type="password" class="form-control" id="pin">
    </div>
  </div>
  <div class="d-grid">
    <button class="btn btn-lg btn-primary" id="submit" type="button">產生數位簽章</button>

  </div>

  <hr>
  <div id="div-sig" class="d-none">
    <h2>數位簽章結果</h2>
    <div class="mb-3">
      <label for="filename">檔案名稱</label>
      <input type="text" class="form-control" id="filename">
    </div>
    <div class="mb-3">
      <label for="filehash">檔案 Hash 值</label>
      <input type="text" class="form-control" id="filehash">
    </div>
    <div class="mb-3 d-none">
      <label for="raw">TBS</label>
      <textarea id="raw" class="form-control" rows="3"></textarea>
    </div>
    <div class="mb-3 d-none">
      <label for="signature">簽章值</label>
      <textarea id="signature" class="form-control" rows="3"></textarea>
      <textarea id="info" class="form-control d-none" rows="2"></textarea>
    </div>
    <div class="mb-3">
      <label for="p7s">p7s</label>
      <textarea id="p7s" class="form-control mb-2" rows="3"></textarea>
      <button type="button" id="dl_p7s_der" class="btn btn-primary">下載 p7s (DER)</button>
      <button type="button" id="dl_p7s_pem" class="btn btn-primary">下載 p7s (PEM)</button>
    </div>
    <div class="mb-3">
      <label for="p7m">p7m</label>
      <textarea id="p7m" class="form-control mb-2" rows="3"></textarea>
      <button type="button" id="dl_p7m_der" class="btn btn-primary">下載 p7m (DER)</button>
      <button type="button" id="dl_p7m_pem" class="btn btn-primary">下載 p7m (PEM)</button>
    </div>
    <hr>
  </div>
  
  
  <h2>驗簽方法</h2>
  <p>p7s (DER)：<br>openssl smime -verify -inform DER -in &lt;p7s檔&gt; -content &lt;原始檔&gt; -noverify | grep Verification</p>
  <p>p7s (PEM)：<br>openssl smime -verify -inform PEM -in &lt;p7s檔&gt; -content &lt;原始檔&gt; -noverify | grep Verification</p>
  <p>p7m (DER)：<br>openssl smime -verify -inform DER -in &lt;p7m檔&gt; -noverify | grep Verification</p>
  <p>p7m (PEM)：<br>openssl smime -verify -inform PEM -in &lt;p7m檔&gt; -noverify | grep Verification</p>
</div>

<link href="
https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css
" rel="stylesheet">
  
      <script id="rendered-js" type="module">
import * as asn1js from "https://cdn.jsdelivr.net/npm/asn1js@3.0.5/+esm";
const HASH_ALGO_OID = {
  "SHA-1": "1.3.14.3.2.26",
  "SHA-256": "2.16.840.1.101.3.4.2.1",
  "SHA-384": "2.16.840.1.101.3.4.2.2",
  "SHA-512": "2.16.840.1.101.3.4.2.3" };


let signedAttr;
let POPUP_FORM, POPUP_TIMEOUT;

async function submit() {
  document.getElementById('div-sig').classList.remove("d-none");
  const file = document.getElementById("fileInput").files[0];
  const hashAlgo = document.getElementById("hashAlgo").value;
  if (!file) {
    alert("請選擇檔案");
  }
  document.getElementById("filename").value = file.name;
  const arrayBuffer = await file.arrayBuffer();
  const hashBuffer = await crypto.subtle.digest(hashAlgo, arrayBuffer);
  document.getElementById("filehash").value = bufToHex(hashBuffer);

  signedAttr = getSignedAttr(hashBuffer);
  const signedAttrSet = new asn1js.Set({ value: signedAttr });

  document.getElementById("raw").value = bufToB64(signedAttrSet.toBER());

  POPUP_FORM = window.open(
  "http://localhost:61161/popupForm",
  "popupForm",
  "height=200, width=200, left=100, top=20");

  POPUP_TIMEOUT = setTimeout(() => {
    POPUP_FORM.close();
    alert("請檢查是否安裝 HiPKI Local Server，並允許瀏覽器彈出視窗");
  }, 5000);
}
document.getElementById("submit").addEventListener("click", submit);

async function receiveMessage(event) {
  if (event.origin !== "http://localhost:61161") return;

  let ret = JSON.parse(event.data);
  if (ret.func === "getTbs") {
    // 進行數位簽章
    clearTimeout(POPUP_TIMEOUT);
    const tbsData = {
      func: "MakeSignature",
      signatureType: "PKCS1",
      tbsEncoding: "base64",
      tbs: document.getElementById("raw").value,
      pin: document.getElementById("pin").value,
      hashAlgorithm: document.getElementById("hashAlgo").value.replace("-", "") };

    POPUP_FORM.postMessage(JSON.stringify(tbsData), "*");
  } else {
    // 將簽章結果寫入欄位
    const result = JSON.parse(event.data);
    document.getElementById("signature").value = ret.signature;
    document.getElementById("info").value = JSON.stringify(ret);
    await genPkcs7(result);
  }
}

window.addEventListener("message", receiveMessage, false);

function getSignedAttr(hash) {
  const attr = [
  new asn1js.Sequence({
    value: [
    new asn1js.ObjectIdentifier({ value: "1.2.840.113549.1.9.3" }), // contentType (PKCS #9)
    new asn1js.Set({
      value: [
      new asn1js.ObjectIdentifier({ value: "1.2.840.113549.1.7.1" }) // data (PKCS #7)
      ] })] }),



  new asn1js.Sequence({
    value: [
    new asn1js.ObjectIdentifier({ value: "1.2.840.113549.1.9.4" }), // messageDigest (PKCS #9)
    new asn1js.Set({
      value: [
      new asn1js.OctetString({
        valueHex: hash })] })] })];






  return attr;
}

async function genPkcs7(data) {
  // 從憑證取得 serialNumber、issuer
  const certb64 = data.certb64;
  const cert = asn1js.fromBER(b64ToBuf(certb64)).result;
  const serialNumber = cert.valueBlock.value[0].valueBlock.value[1];
  const issuer = cert.valueBlock.value[0].valueBlock.value[3];

  // 取得簽章值
  const signature = data.signature;
  document.getElementById("signature").value = signature;

  // 計算 SingerInfo
  const hashOid = HASH_ALGO_OID[document.getElementById("hashAlgo").value];
  const signerInfo = getSingerInfo(
  issuer,
  serialNumber,
  signedAttr,
  signature,
  hashOid);


  // 計算 SignedData
  const signedData = getSignedData(signerInfo, cert, hashOid);

  // 計算 ContentInfo
  const contentInfo = getContentInfo(signedData);
  const pkcs7 = contentInfo.toBER(false);
  document.getElementById("p7s").value = bufToB64(pkcs7);

  // 產生 p7m
  const file = document.getElementById("fileInput").files[0];
  const arrayBuffer = await file.arrayBuffer();
  const signedDataP7m = getSignedDataP7m(signerInfo, cert, hashOid, arrayBuffer);
  const contentInfoP7m = getContentInfo(signedDataP7m);
  const p7m = contentInfoP7m.toBER(false);
  document.getElementById("p7m").value = bufToB64(p7m);
}

function getSingerInfo(issuer, serialNumber, signedAttr, sigature, hashOid) {
  return new asn1js.Sequence({
    value: [
    new asn1js.Integer({ value: 1 }),
    new asn1js.Sequence({
      value: [issuer, serialNumber] }),

    // digestAlgorithms
    new asn1js.Sequence({
      value: [
      new asn1js.ObjectIdentifier({ value: hashOid }),
      new asn1js.Null()] }),


    new asn1js.Constructed({
      optional: true,
      idBlock: { tagClass: 3, tagNumber: 0 },
      value: signedAttr }),

    // digestAlgorithms
    new asn1js.Sequence({
      value: [
      new asn1js.ObjectIdentifier({ value: "1.2.840.113549.1.1.1" }),
      new asn1js.Null()] }),


    new asn1js.OctetString({ valueHex: b64ToBuf(sigature) })] });


}

function getSignedData(signerInfo, cert, hashOid) {
  return new asn1js.Sequence({
    value: [
    // version
    new asn1js.Integer({ value: 1 }),
    // digestAlgorithms
    new asn1js.Set({
      value: [
      // DigestAlgorithmIdentifier
      new asn1js.Sequence({
        value: [
        new asn1js.ObjectIdentifier({ value: hashOid }), // sha1
        new asn1js.Null()] })] }),




    // encapContentInfo
    new asn1js.Sequence({
      value: [
      new asn1js.ObjectIdentifier({ value: "1.2.840.113549.1.7.1" }) // data
      ] }),

    // CertificateSet
    new asn1js.Constructed({
      optional: true,
      idBlock: {
        tagClass: 3, // CONTEXT-SPECIFIC
        tagNumber: 0 // [0]
      },
      value: [
      // CertificateChoices
      cert] }),


    // signerInfos
    new asn1js.Set({
      value: [signerInfo] })] });



}

function getSignedDataP7m(signerInfo, cert, hashOid, tbs) {
  return new asn1js.Sequence({
    value: [
    // version
    new asn1js.Integer({ value: 1 }),
    // digestAlgorithms
    new asn1js.Set({
      value: [
      // DigestAlgorithmIdentifier
      new asn1js.Sequence({
        value: [
        new asn1js.ObjectIdentifier({ value: hashOid }), // sha1
        new asn1js.Null()] })] }),




    // encapContentInfo
    new asn1js.Sequence({
      value: [
      new asn1js.ObjectIdentifier({ value: "1.2.840.113549.1.7.1" }), // data
      new asn1js.Constructed({
        optional: true,
        idBlock: {
          tagClass: 3, // CONTEXT-SPECIFIC
          tagNumber: 0 // [0]
        },
        value: [
        new asn1js.OctetString({
          valueHex: tbs })] })] }),





    // CertificateSet
    new asn1js.Constructed({
      optional: true,
      idBlock: {
        tagClass: 3, // CONTEXT-SPECIFIC
        tagNumber: 0 // [0]
      },
      value: [
      // CertificateChoices
      cert] }),


    // signerInfos
    new asn1js.Set({
      value: [signerInfo] })] });



}

function getContentInfo(signedData) {
  return new asn1js.Sequence({
    value: [
    new asn1js.ObjectIdentifier({ value: "1.2.840.113549.1.7.2" }), // signedData
    new asn1js.Constructed({
      optional: true,
      idBlock: { tagClass: 3, tagNumber: 0 },
      value: [signedData] })] });



}

function bufToHex(buf) {
  return Array.from(new Uint8Array(buf)).
  map(b => b.toString(16).padStart(2, "0")).
  join("");
}

function bufToB64(buf) {
  return btoa(String.fromCharCode.apply(null, new Uint8Array(buf)));
}

function b64ToBuf(b64) {
  return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
}

function dl_p7s_der() {
  const filename = document.getElementById("fileInput").files[0].name;
  let p7s = document.getElementById("p7s").value;
  p7s = Uint8Array.from(atob(p7s), c => c.charCodeAt(0));
  const blob = new Blob([p7s], { type: "application/octet-stream" });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename + "_der.p7s";
  a.click();
  URL.revokeObjectURL(url);
}
document.getElementById("dl_p7s_der").addEventListener("click", dl_p7s_der);

function dl_p7s_pem() {
  const filename = document.getElementById("fileInput").files[0].name;
  let p7s = document.getElementById("p7s").value;
  p7s =
  "-----BEGIN PKCS7-----\n" +
  p7s.match(new RegExp(`.{1,64}`, "g")).join("\n") +
  "\n-----END PKCS7-----";
  const blob = new Blob([p7s], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename + "_pem.p7s";
  a.click();
  URL.revokeObjectURL(url);
}
document.getElementById("dl_p7s_pem").addEventListener("click", dl_p7s_pem);

function dl_p7m_der() {
  const filename = document.getElementById("fileInput").files[0].name;
  let p7m = document.getElementById("p7m").value;
  p7m = Uint8Array.from(atob(p7m), c => c.charCodeAt(0));
  const blob = new Blob([p7m], { type: "application/octet-stream" });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename + "_der.p7m";
  a.click();
  URL.revokeObjectURL(url);
}
document.getElementById("dl_p7m_der").addEventListener("click", dl_p7m_der);

function dl_p7m_pem() {
  const filename = document.getElementById("fileInput").files[0].name;
  let p7m = document.getElementById("p7m").value;
  p7m =
  "-----BEGIN PKCS7-----\n" +
  p7m.match(new RegExp(`.{1,64}`, "g")).join("\n") +
  "\n-----END PKCS7-----";
  const blob = new Blob([p7m], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename + "_pem.p7m";
  a.click();
  URL.revokeObjectURL(url);
}
document.getElementById("dl_p7m_pem").addEventListener("click", dl_p7m_pem);
//# sourceURL=pen.js
    </script>

  
</body>

</html>
